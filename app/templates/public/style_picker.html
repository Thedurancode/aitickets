{% extends "base.html" %}

{% block title %}Pick a Flyer Style{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <!-- Header -->
    <div class="text-center mb-8">
        <div class="text-4xl mb-3">&#127912;</div>
        <h1 class="text-2xl sm:text-3xl font-bold mb-2">Pick a Flyer Style</h1>
        {% if event %}
        <p class="text-gray-400">for <span class="text-white font-semibold">{{ event.name }}</span></p>
        {% endif %}
    </div>

    {% if is_expired %}
    <!-- Expired state -->
    <div class="text-center py-16">
        <div class="text-5xl mb-4">&#9203;</div>
        <h2 class="text-xl font-bold text-gray-300 mb-2">Link Expired</h2>
        <p class="text-gray-500">This style picker link has expired. Request a new one.</p>
    </div>

    {% elif already_selected %}
    <!-- Already selected state -->
    <div class="text-center py-16">
        <div class="text-5xl mb-4">&#10004;&#65039;</div>
        <h2 class="text-xl font-bold mb-2" style="color: {{ org_color }}">Style Selected!</h2>
        {% if selected_style_name %}
        <p class="text-gray-400">You chose <span class="text-white font-semibold">"{{ selected_style_name }}"</span>.</p>
        {% endif %}
        <p class="text-gray-500 mt-2">Your flyer is being generated.</p>
    </div>

    {% else %}
    <!-- Style cards grid -->
    <div id="styles-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for style in styles %}
        <button onclick="selectStyle({{ style.id }}, '{{ style.name | replace("'", "\\'") }}')"
                class="group bg-gray-900 rounded-xl overflow-hidden border-2 border-gray-800
                       hover:border-brand transition-all duration-200 text-left cursor-pointer
                       focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2 focus:ring-offset-gray-950">
            <!-- Style image or placeholder -->
            <div class="aspect-[4/3] bg-gray-800 overflow-hidden relative">
                {% if style.image_url %}
                <img src="{{ style.image_url }}" alt="{{ style.name }}"
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                {% else %}
                <div class="w-full h-full flex items-center justify-center gradient-fallback">
                    <span class="text-5xl opacity-60">&#127912;</span>
                </div>
                {% endif %}
                <!-- Hover overlay -->
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-200 flex items-center justify-center">
                    <span class="text-white font-semibold text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200
                                 bg-black/60 backdrop-blur-sm px-4 py-2 rounded-full">
                        Select
                    </span>
                </div>
            </div>
            <!-- Style info -->
            <div class="p-4">
                <h3 class="font-bold text-white text-lg mb-1">{{ style.name }}</h3>
                <p class="text-gray-400 text-sm line-clamp-2">{{ style.description }}</p>
            </div>
        </button>
        {% endfor %}
    </div>

    <!-- Empty state -->
    {% if not styles %}
    <div class="text-center py-16 text-gray-500">
        <div class="text-5xl mb-4 opacity-40">&#128247;</div>
        <p class="text-lg">No flyer styles available yet.</p>
        <p class="text-sm mt-1">Ask the organizer to add some styles first.</p>
    </div>
    {% endif %}

    <!-- Confirmation overlay (hidden by default) -->
    <div id="confirm-overlay" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl p-6 max-w-sm w-full text-center border border-gray-700 animate-scale-in">
            <div class="text-3xl mb-3">&#127912;</div>
            <h3 class="text-lg font-bold mb-1">Use this style?</h3>
            <p class="text-gray-400 mb-6" id="confirm-name"></p>
            <div class="flex gap-3">
                <button onclick="cancelSelection()"
                        class="flex-1 py-3 rounded-xl bg-gray-800 text-gray-300 font-medium hover:bg-gray-700 transition-colors">
                    Cancel
                </button>
                <button onclick="confirmSelection()" id="confirm-btn"
                        class="flex-1 py-3 rounded-xl font-medium text-white transition-colors" style="background-color: {{ org_color }}">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Success state (hidden by default) -->
    <div id="success-state" class="hidden text-center py-16">
        <div class="text-5xl mb-4">&#127881;</div>
        <h2 class="text-xl font-bold mb-2" style="color: {{ org_color }}">Style Selected!</h2>
        <p class="text-gray-400" id="success-message"></p>
        <p class="text-gray-500 mt-2">Your flyer will be generated shortly.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if not already_selected and not is_expired %}
<script>
var pendingStyleId = null;
var pendingStyleName = '';

function selectStyle(id, name) {
    pendingStyleId = id;
    pendingStyleName = name;
    document.getElementById('confirm-name').textContent = '"' + name + '"';
    document.getElementById('confirm-overlay').classList.remove('hidden');
}

function cancelSelection() {
    document.getElementById('confirm-overlay').classList.add('hidden');
    pendingStyleId = null;
}

function confirmSelection() {
    var btn = document.getElementById('confirm-btn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    btn.style.opacity = '0.6';

    fetch('/pick-style/{{ session.token }}/select', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({style_id: pendingStyleId})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            document.getElementById('confirm-overlay').classList.add('hidden');
            document.getElementById('styles-grid').classList.add('hidden');
            document.getElementById('success-state').classList.remove('hidden');
            document.getElementById('success-message').textContent =
                'You chose "' + pendingStyleName + '".';
        } else {
            alert(data.error || 'Something went wrong. Please try again.');
            btn.disabled = false;
            btn.textContent = 'Confirm';
            btn.style.opacity = '1';
        }
    })
    .catch(function() {
        alert('Network error. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Confirm';
        btn.style.opacity = '1';
    });
}
</script>
{% endif %}
{% endblock %}
